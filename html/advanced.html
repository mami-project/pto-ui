<h1>Observatory</h1>
<form>
<h5 id="mock-title" ng-click="mockInterface = !mockInterface"><span class="glyphicon glyphicon-{{ mockInterface ? 'collapse-down' : 'expand'}}" aria-hidden="true"></span> Mocking</h5>
<section ng-show="mockInterface">
	<div class="form-group">
		<label>Number of Results (Paths)</label>
		<input type="number" ng-model="mock.numberPathGroups"></input>
	</div>
	<div class="form-group">
		<label>Number of Observations</label>
		<input type="number" ng-model="mock.numberObservations"></input>
	</div>
	<button class="btn btn-primary" ng-click="mock.generate(); fetchResults(query); ">Generate Mock Data</button>
</section>

<section ng-show="!mockInterface" id="query-form">
<h3 ng-click="showCriteria = !showCriteria"><span class="glyphicon glyphicon-{{ showCriteria ? 'collapse-down' : 'expand'}}" aria-hidden="true"></span> Path criteria</h3>
<div ng-show="showCriteria">
<p>
Specify which paths you want to include. You may leave field blanks to indicate that
no filtering for the field should be done.
</p>

<div class="form-group">
	<label>Startpoint</label>
	<input id="sip_ips" type="text" class="form-control" placeholder="" ng-model="query.sip">
	<small class="text-muted">Enter an IPv4 or IPv6 address.</small> 
</div>
<div class="form-group">
	<label>On path</label>
	<input id="on_path_ips" type="text" class="form-control" placeholder="" ng-model="query.on_path">
	<small class="text-muted">Enter IPv4 or IPv6 addresses that should be contained within the path. Use comma to separate multiple addresses.</small>
</div>
<div class="form-group">
	<label>Endpoint</label>
	<input id="dip_ips" type="text" class="form-control" placeholder="" ng-model="query.dip">
	<small class="text-muted">Enter an IPv4 or IPv6 address.</small>
</div>
<div class="form-group">
	<label>From Date</label>
	<div class="input-group">
	    <input type="text" class="form-control" datetime-picker="dd MMM yyyy HH:mm" ng-model="query.from" is-open="fromIsOpen" save-as="number"/>
	    <span class="input-group-btn">
	        <button type="button" class="btn btn-default" ng-click="openFromCalendar($event, prop)"><i class="fa fa-calendar"></i></button>
	    </span>
	</div>
	 <small class="text-muted">Enter a Date</small>
</div>
<div class="form-group">
	<label>To Date</label>
	<div class="input-group">
	    <input type="text" class="form-control" datetime-picker="dd MMM yyyy HH:mm" ng-model="query.to" is-open="toIsOpen" save-as="number"/>
	    <span class="input-group-btn">
	        <button type="button" class="btn btn-default" ng-click="openToCalendar($event, prop)"><i class="fa fa-calendar"></i></button>
	    </span>
	</div>
	<small class="text-muted">Enter a Date</small>
</div>
</div>
<h3 ng-click="showConditions = !showConditions"><span class="glyphicon glyphicon-{{ showConditions ? 'collapse-down' : 'expand'}}" aria-hidden="true"></span> Conditions</h3>
<div ng-show="showConditions">
<p>
Specify observation conditions.
</p>

<fieldset ng-repeat="(idx, condition) in query.conditions">
<!--<legend>{{ condition.op.length > 0 ? condition.op + " " + condition.name : condition.name }}</legend>-->
<div class="form-group" ng-if="idx > 0">
	<label>Operator</label>
	<select class="form-control" ng-model="condition.op">
		<option value=":">AND</option>
		<option value=",">OR</option>
	</select>
	<small class="text-muted">Select a condition.</small>
</div>
<div class="form-group">
	<label>Name</label>
	<select class="form-control" ng-model="condition.name">
		<option ng-repeat="cname in allConditions" value="{{ cname }}">{{ cname }}</option>
	</select>
	<small class="text-muted">Select a condition.</small>
</div>
</fieldset>

<p></p>

<button type="button" ng-click="(query.conditions.length <= 1) ? query.conditions.push({ name: ''}) : query.conditions.push({ name: '', op: ':'})" class="btn btn-default" aria-label="add condition"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
<button type="button" ng-click="query.conditions.pop()" class="btn btn-default" aria-label="remove condition"><span class="glyphicon glyphicon-minus" aria-hidden="true"></span></button>
</div>

<h3 ng-click="showQuery = !showQuery"><span class="glyphicon glyphicon-{{ showQuery ? 'collapse-down' : 'expand'}}" aria-hidden="true"></span> Query</h3>
<div ng-show="showQuery">
<p>
Specify Query Type.
</p>
<fieldset>
	<div class="radio">
		<label>
		<input type="radio" value="default" ng-model="queryType">
			Standard Query
		</label>
	</div>
	<div class="radio">
		<label>
		<input type="radio" value="grouped" ng-model="queryType">
			Group by Network Paths
		</label>
	</div>	
</fieldset>
</div>
<button type="button" ng-click="fetchResults(query)" class="btn btn-primary" aria-label="submit"><span ng-show="!fetching" class="glyphicon glyphicon-search" aria-hidden="true"></span><span ng-show="fetching" class="glyphicon glyphicon-repeat spinning" aria-hidden="true"></span> Submit</button>
</form>	
</section>

<h3>Results</h3>
<section ng-show="isError">
	<div class="alert alert-danger" role="alert">
		<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
		<span class="sr-only">Error:</span>
		{{ errorResponse.status + " " + errorResponse.statusText + " " + errorResponse.data.err}}
	</div>
</section>
<section>
<p>Showing <span id="results">{{ results.length }}</span> <!--<span id="results_total">{{ totalresults }}</span>--> matching paths. Currently we know about <span id="results_max">{{ maxresults }}</span> paths in total.</p>

<div id="show_data">
	<span ng-show="results.length === 0" class="info">(no data to show)</span>
	<div class="obs_path" ng-repeat="(idx, result) in results">
		<div class="">
			<div class="pie-chart-container well col-sm-6"><piechart renderdata="result" colormap="colorMap[idx]"></piechart></div>
			<div class="col-sm-6 result-overview">
				<dl class="dl-horizontal"><dt>Path:</dt><dd>{{ result.sip + " - * - " + result.dip }}</dd>
					<dt>Observations:</dt><dd>{{ result.observations.length }}</dd>
					<dt>From:</dt><dd>{{ formatTime(getTimeWindow(result.observations).start) }}</dd>
					<dt>To:</dt><dd>{{ formatTime(getTimeWindow(result.observations).end) }}</dd>
				</dl>
			</div>
		</div>
		<div class="clearfix"></div>
		<div class="well"><timeline renderdata="result" colormap="colorMap[idx]" mousein="timeLineMouseIn(group, obs)" mouseout="timeLineMouseOut(group, obs)" click="timeLineClick(group, obs)"></timeline></div>
		<table class="table table-condensed">
			<thead>
				<tr>
					<th>Analyzer</th>
					<th>From</th>
					<th>To</th>
					<th>Conditions</th>
				</tr>
			</thead>
			<tbody>
				<tr ng-repeat="observation in result.observations" class="{{ observation.highlighted ? 'success' : '' }}{{ observation.rejected ? ' rejected' : '' }}">
					<td>{{ observation.analyzer }}</td>
					<td>{{ formatTime(observation.time.from['$date']) }}</td>
					<td>{{ formatTime(observation.time.to['$date']) }}</td>
					<td>{{ observation.conditions.join(', ') }}</td>
				</tr>
			</tbody>
		</table>
	</div>
</div>
<div ng-show="query.limit > 0">
<p>page #<span id="page_num">{{ query.skip/query.limit }}</span> <a id="nextlink" ng-click="nextPage()"> next</a></p>
<div>
<p>Direct Link: <a href="{{ directLink }}" id="directlink">{{ directLink }}</a></p>
</section>